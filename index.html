<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVA-PRO | Gest√£o de Folha e F√©rias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        :root { --bg-dark: #0f172a; --accent-blue: #2563eb; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: #f1f5f9; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card-dark { background-color: #1e293b; border: 1px solid #334155; }

        #holerite-preview-container {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            overflow-y: auto;
            padding: 2rem;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; padding: 0 !important; }
            #holerite-preview-container { position: static; display: block !important; background: white; padding: 0; }
            .holerite-page {
                width: 100%;
                max-width: 800px;
                margin: 0 auto 20px auto;
                border: 1px solid #000;
                padding: 15px;
                page-break-after: always;
                font-size: 10px !important;
                color: black !important;
            }
            .holerite-page table { width: 100%; border-collapse: collapse; }
            .holerite-page th, .holerite-page td { border: 1px solid black; padding: 4px; }
        }
    </style>
</head>
<body class="antialiased">

    <!-- LOGIN -->
    <section id="auth-container" class="fixed inset-0 bg-slate-950 flex items-center justify-center p-4 z-[100]">
        <div class="bg-slate-900 w-full max-w-md rounded-3xl shadow-2xl p-8 border border-slate-800">
            <div class="text-center mb-8">
                <span class="bg-blue-600 text-white px-5 py-2 rounded-lg font-black italic tracking-tighter text-3xl shadow-lg shadow-blue-500/20">DVA-PRO</span>
                <p class="text-slate-500 text-[10px] font-bold uppercase mt-6 tracking-widest">Controle Ponto</p>
            </div>
            <form id="form-login" class="space-y-4">
                <input type="text" id="login-user" placeholder="Usu√°rio" required class="w-full p-4 bg-slate-800 border border-slate-700 rounded-2xl font-bold text-white outline-none focus:ring-2 ring-blue-500">
                <input type="password" id="login-pass" placeholder="Senha" required class="w-full p-4 bg-slate-800 border border-slate-700 rounded-2xl font-bold text-white outline-none focus:ring-2 ring-blue-500">
                <button type="submit" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-black uppercase hover:bg-blue-500 transition-all">Acessar Painel</button>
            </form>
        </div>
    </section>

    <!-- APP PRINCIPAL -->
    <div id="main-app" class="hidden min-h-screen flex flex-col">
        <header class="no-print bg-slate-900 border-b border-slate-800 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="bg-blue-600 px-3 py-1 rounded font-black italic tracking-tighter">DVA-PRO</span>
                    <h1 id="topEmpresaNome" class="text-xs font-bold uppercase text-slate-400">EMPRESA</h1>
                </div>
                <nav class="flex gap-4">
                    <button onclick="showTab('tab-func')" class="text-[10px] font-black uppercase hover:text-blue-500 transition">Equipe</button>
                    <button onclick="showTab('tab-folha')" class="text-[10px] font-black uppercase hover:text-blue-500 transition">Folha</button>
                    <button onclick="showTab('tab-ferias')" class="text-[10px] font-black uppercase hover:text-blue-500 transition text-yellow-500">F√©rias</button>
                    <button onclick="showTab('tab-hist')" class="text-[10px] font-black uppercase hover:text-blue-500 transition">Arquivo</button>
                    <button onclick="showTab('tab-config')" class="text-[10px] font-black uppercase hover:text-blue-500 transition text-slate-500">Ajustes</button>
                    <button onclick="logout()" class="px-3 py-1 bg-red-500/10 text-red-500 rounded-lg text-[10px] font-black uppercase">Sair</button>
                </nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto w-full p-6 no-print">
            
            <!-- ABA: EQUIPE -->
            <section id="tab-func" class="tab-content active">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black uppercase italic tracking-tighter">Gest√£o de Pessoal</h2>
                    <button onclick="abrirModalFunc()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold text-xs uppercase">+ Novo Funcion√°rio</button>
                </div>
                <div id="lista-funcionarios" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </section>

            <!-- ABA: LAN√áAR FOLHA -->
            <section id="tab-folha" class="tab-content">
                <div class="card-dark rounded-3xl p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="flex flex-col gap-1">
                            <label class="text-[9px] font-black text-slate-500 uppercase">Per√≠odo e Tipo</label>
                            <select id="folha-tipo" class="p-3 bg-slate-800 border border-slate-700 rounded-xl text-xs font-bold text-white">
                                <option value="MENSAL (DIA 05)">MENSAL (DIA 05)</option>
                                <option value="ADIANTAMENTO (40%)">ADIANTAMENTO (40%)</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[9px] font-black text-slate-500 uppercase">M√™s/Ano</label>
                            <input type="month" id="folha-mes" class="p-3 bg-slate-800 border border-slate-700 rounded-xl text-xs font-bold text-white">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[9px] font-black text-slate-500 uppercase">Dias √öteis / DSR</label>
                            <div class="flex gap-2">
                                <input type="number" id="cal-uteis" value="26" class="w-1/2 p-3 bg-slate-800 border border-slate-700 rounded-xl text-xs font-bold text-white text-center">
                                <input type="number" id="cal-dsr" value="5" class="w-1/2 p-3 bg-slate-800 border border-slate-700 rounded-xl text-xs font-bold text-white text-center">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-dark rounded-3xl overflow-hidden">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-slate-800/50 text-slate-500 font-black uppercase border-b border-slate-700">
                            <tr>
                                <th class="p-4">Nome / Regime</th>
                                <th class="p-4">H. Extras (H:M)</th>
                                <th class="p-4">Faltas (H:M)</th>
                                <th class="p-4">Adicional</th>
                                <th class="p-4">Desconto</th>
                                <th class="p-4 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-lancamento" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </section>

            <!-- ABA: F√âRIAS -->
            <section id="tab-ferias" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black uppercase italic tracking-tighter">Controle de F√©rias</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="lista-ferias-cards"></div>
            </section>

            <!-- ABA: HIST√ìRICO -->
            <section id="tab-hist" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black uppercase italic tracking-tighter">Arquivo de Recibos</h2>
                    <div class="flex items-center gap-4">
                        <input type="month" id="filtro-hist-mes" onchange="renderHistorico()" class="p-2 bg-slate-800 border border-slate-700 rounded-xl text-xs font-bold text-white">
                        <button onclick="imprimirTudo()" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold text-[10px] uppercase">Imprimir Tudo</button>
                    </div>
                </div>
                <div id="lista-historico" class="space-y-3"></div>
            </section>

            <!-- ABA: CONFIG -->
            <section id="tab-config" class="tab-content">
                <div class="max-w-xl mx-auto card-dark rounded-3xl p-8">
                    <h2 class="text-xl font-black uppercase mb-6">Dados da Empresa</h2>
                    <form id="form-empresa" class="space-y-4">
                        <input type="text" id="emp-nome" placeholder="Nome da Empresa" class="w-full p-4 bg-slate-800 border border-slate-700 rounded-2xl font-bold text-white">
                        <input type="text" id="emp-cnpj" placeholder="CNPJ" class="w-full p-4 bg-slate-800 border border-slate-700 rounded-2xl font-bold text-white">
                        <button type="submit" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-black uppercase">Salvar Ajustes</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL: CADASTRAR FUNCION√ÅRIO -->
    <div id="modal-func" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md hidden items-center justify-center p-4 z-50">
        <div class="bg-slate-900 w-full max-w-lg rounded-3xl p-8 border border-slate-800">
            <h3 class="text-xl font-black uppercase mb-6">Dados do Colaborador</h3>
            <form id="form-cad-func" class="space-y-4">
                <input type="hidden" id="func-id">
                <input type="text" id="func-nome" placeholder="Nome Completo" required class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="func-cargo" placeholder="Cargo" required class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                    <select id="func-regime" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                        <option value="MENSALISTA">MENSALISTA</option>
                        <option value="HORISTA">HORISTA</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-500 uppercase">Valor Sal√°rio / Hora</label>
                        <input type="number" id="func-salario" step="0.01" required class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-500 uppercase">Data Admiss√£o</label>
                        <input type="date" id="func-admissao" required class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                    </div>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="fecharModalFunc()" class="flex-1 p-3 bg-slate-800 text-slate-400 rounded-xl font-black uppercase text-xs">Sair</button>
                    <button type="submit" class="flex-1 p-3 bg-blue-600 text-white rounded-xl font-black uppercase text-xs">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: LAN√áAR F√âRIAS -->
    <div id="modal-ferias" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md hidden items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-slate-900 w-full max-w-lg rounded-3xl p-8 border border-slate-800 my-8">
            <h3 class="text-xl font-black uppercase mb-2">Lan√ßar Recibo de F√©rias</h3>
            <p id="ferias-nome-display" class="text-blue-500 font-bold text-xs uppercase mb-6"></p>
            <form id="form-lancar-ferias" class="space-y-4">
                <input type="hidden" id="ferias-func-id">
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-500 uppercase">Data In√≠cio</label>
                        <input type="date" id="fer-data-inicio" required class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-500 uppercase">Dias de Gozo</label>
                        <input type="number" id="fer-dias-gozo" value="30" required class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                    </div>
                </div>
                
                <!-- M√âDIA DE HORAS EXTRAS (CALCULADA OU MANUAL) -->
                <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50">
                    <label class="text-[9px] font-black text-blue-400 uppercase">M√©dias Legais (Autom√°tico p/ 12 meses)</label>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div class="flex flex-col gap-1">
                            <label class="text-[8px] text-slate-500 uppercase italic">M√©dia Horas Mensal</label>
                            <input type="number" id="fer-media-horas" value="0" step="0.01" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[8px] text-slate-500 uppercase italic">Adicional HE (%)</label>
                            <input type="number" id="fer-media-percent" value="50" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                        </div>
                    </div>
                </div>

                <!-- OUTROS LAN√áAMENTOS -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-green-500 uppercase">Outros Adicionais (B√¥nus, etc)</label>
                        <input type="number" id="fer-extra-add" value="0" step="0.01" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-red-500 uppercase">Outros Descontos</label>
                        <input type="number" id="fer-extra-desc" value="0" step="0.01" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                    </div>
                </div>

                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-black text-slate-500 uppercase">Abono Pecuni√°rio (Venda de 10 dias?)</label>
                    <input type="number" id="fer-dias-venda" value="0" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white">
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="fecharModalFerias()" class="flex-1 p-3 bg-slate-800 text-slate-400 rounded-xl font-black uppercase text-xs">Sair</button>
                    <button type="submit" class="flex-1 p-3 bg-yellow-600 text-white rounded-xl font-black uppercase text-xs">Gerar F√©rias</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PREVIEW HOLERITE -->
    <div id="holerite-preview-container" class="no-print">
        <div class="max-w-4xl mx-auto flex flex-col gap-4">
            <div class="flex justify-between items-center text-white p-4 bg-slate-900 rounded-2xl no-print border border-slate-800">
                <h2 class="text-xl font-black uppercase">Visualiza√ß√£o de Documento</h2>
                <div class="flex gap-4">
                    <button onclick="window.print()" class="bg-blue-600 px-6 py-2 rounded-xl font-bold text-xs uppercase">Imprimir</button>
                    <button onclick="closeHolerite()" class="bg-slate-800 px-6 py-2 rounded-xl font-bold text-xs uppercase">Fechar</button>
                </div>
            </div>
            <div id="print-area"></div>
        </div>
    </div>

    <script>
        let db = {
            empresa: JSON.parse(localStorage.getItem('dva_emp')) || { nome: 'JCAD INDUSTRIA METALURGICA LTDA', cnpj: '21035310/0001-11' },
            funcionarios: JSON.parse(localStorage.getItem('dva_func')) || [],
            historico: JSON.parse(localStorage.getItem('dva_hist')) || [],
            ferias_gozadas: JSON.parse(localStorage.getItem('dva_ferias')) || []
        };

        function init() {
            document.getElementById('topEmpresaNome').innerText = db.empresa.nome;
            document.getElementById('emp-nome').value = db.empresa.nome;
            document.getElementById('emp-cnpj').value = db.empresa.cnpj;
            const now = new Date();
            const monthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('folha-mes').value = monthStr;
            document.getElementById('filtro-hist-mes').value = monthStr;
            
            renderFuncionarios();
            renderTabelaFolha();
            renderHistorico();
            renderFerias();
        }

        function renderFuncionarios() {
            const list = document.getElementById('lista-funcionarios');
            list.innerHTML = db.funcionarios.map(f => `
                <div class="card-dark p-6 rounded-3xl">
                    <div class="flex justify-between items-start">
                        <div class="text-[8px] font-black text-blue-500 uppercase mb-1">${f.regime}</div>
                        <div class="text-[8px] font-bold text-slate-500 uppercase">Desde: ${f.admissao.split('-').reverse().join('/')}</div>
                    </div>
                    <h3 class="text-sm font-black text-white uppercase">${f.nome}</h3>
                    <p class="text-[10px] text-slate-500 uppercase">${f.cargo}</p>
                    <div class="mt-4 flex gap-2 border-t border-slate-700 pt-4">
                        <button onclick="editarFunc('${f.id}')" class="text-xs text-blue-400 font-bold uppercase">Editar</button>
                        <button onclick="deletarFunc('${f.id}')" class="text-xs text-red-500 font-bold uppercase">Excluir</button>
                    </div>
                </div>
            `).join('');
        }

        function renderFerias() {
            const list = document.getElementById('lista-ferias-cards');
            const hoje = new Date();
            list.innerHTML = db.funcionarios.map(f => {
                const admissao = new Date(f.admissao);
                const meses = (hoje.getFullYear() - admissao.getFullYear()) * 12 + (hoje.getMonth() - admissao.getMonth());
                const diasDireito = Math.floor(meses * 2.5);
                const gozados = db.ferias_gozadas.filter(g => g.funcId === f.id).reduce((acc, curr) => acc + (curr.diasGozo || 0) + (curr.diasVenda || 0), 0);
                const saldo = Math.max(0, diasDireito - gozados);
                return `
                    <div class="card-dark p-6 rounded-3xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 text-[40px] opacity-10 font-black">üå¥</div>
                        <h3 class="text-sm font-black text-white uppercase mb-1">${f.nome}</h3>
                        <p class="text-[9px] text-slate-500 uppercase mb-4">Direito: ${diasDireito} | Saldo: ${saldo} dias</p>
                        <button onclick="abrirModalFerias('${f.id}')" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white p-2 rounded-xl text-[10px] font-black uppercase transition-colors">Lan√ßar F√©rias</button>
                    </div>
                `;
            }).join('');
        }

        function abrirModalFerias(id) {
            const f = db.funcionarios.find(x => x.id === id);
            document.getElementById('ferias-func-id').value = id;
            document.getElementById('ferias-nome-display').innerText = f.nome;
            
            // --- C√ÅLCULO AUTOM√ÅTICO DE M√âDIA DE HORAS EXTRAS ---
            // Buscamos nos √∫ltimos 12 meses de hist√≥rico
            const hoje = new Date();
            const mesesAquisitivos = [];
            for (let i = 0; i < 12; i++) {
                const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                mesesAquisitivos.push(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`);
            }

            const historicoHE = db.historico.filter(h => 
                h.funcId === id && 
                mesesAquisitivos.includes(h.mes) &&
                h.tipo.includes("MENSAL")
            );

            const totalHorasNoPeriodo = historicoHE.reduce((acc, curr) => acc + (curr.totalHex || 0), 0);
            const mediaCalculada = totalHorasNoPeriodo / 12;

            // Preenche o campo de m√©dia autom√°tica, mas permite altera√ß√£o
            document.getElementById('fer-media-horas').value = mediaCalculada.toFixed(2);
            document.getElementById('fer-extra-add').value = 0;
            document.getElementById('fer-extra-desc').value = 0;
            
            document.getElementById('modal-ferias').style.display = 'flex';
        }

        function fecharModalFerias() { document.getElementById('modal-ferias').style.display = 'none'; }

        document.getElementById('form-lancar-ferias').onsubmit = (e) => {
            e.preventDefault();
            const fId = document.getElementById('ferias-func-id').value;
            const f = db.funcionarios.find(x => x.id === fId);
            const diasGozo = parseInt(document.getElementById('fer-dias-gozo').value);
            const diasVenda = parseInt(document.getElementById('fer-dias-venda').value);
            const dataInicio = document.getElementById('fer-data-inicio').value;
            
            const mediaMensalHoras = parseFloat(document.getElementById('fer-media-horas').value) || 0;
            const percentualHE = (parseFloat(document.getElementById('fer-media-percent').value) || 50) / 100;
            
            const extraAddManual = parseFloat(document.getElementById('fer-extra-add').value) || 0;
            const extraDescManual = parseFloat(document.getElementById('fer-extra-desc').value) || 0;

            let salarioBase;
            if (f.salario > 500) { salarioBase = f.salario; } 
            else { salarioBase = f.salario * 220; }

            const valorHoraAtual = salarioBase / 220;
            const valorMediaHE = (mediaMensalHoras * valorHoraAtual * (1 + percentualHE));

            // A base de c√°lculo para as f√©rias √© Sal√°rio + M√©dias
            const baseMensalIntegral = salarioBase + valorMediaHE;
            const valorDiaBase = baseMensalIntegral / 30;

            const valorGozo = valorDiaBase * diasGozo;
            const umTercoGozo = valorGozo / 3;
            
            const valorVenda = valorDiaBase * diasVenda;
            const umTercoVenda = valorVenda / 3;

            // Totais
            const totalVencimentos = valorGozo + umTercoGozo + valorVenda + umTercoVenda + extraAddManual;
            // INSS incide apenas sobre gozo + 1/3 (abono pecuni√°rio √© isento)
            const baseInss = valorGozo + umTercoGozo;
            const inss = baseInss * 0.09; 
            
            const totalDescontos = inss + extraDescManual;
            const liquido = totalVencimentos - totalDescontos;

            const registroFerias = {
                id: `FER-${Date.now()}`,
                funcId: f.id,
                nome: f.nome,
                cargo: f.cargo,
                tipo: "RECIBO DE F√âRIAS",
                mes: dataInicio.substring(0, 7),
                dataInicio,
                diasGozo,
                diasVenda,
                salarioBase,
                valorMediaHE,
                mediaMensalHoras,
                extraAddManual,
                extraDescManual,
                valorGozo,
                umTercoGozo,
                valorVenda,
                umTercoVenda,
                inss,
                liquido,
                regime: f.regime
            };

            db.ferias_gozadas.push({ funcId: f.id, dataInicio, diasGozo, diasVenda });
            db.historico.push(registroFerias);
            
            salvarDB();
            fecharModalFerias();
            renderFerias();
            renderHistorico();
            visualizarHolerite(registroFerias.id);
        };

        function gerarTemplateF√©rias(h) {
            return `
                <div class="holerite-page">
                    <div class="border border-black p-2 flex justify-between items-center mb-1">
                        <div><h1 class="font-bold text-sm uppercase">${db.empresa.nome}</h1><p class="text-[9px]">CNPJ: ${db.empresa.cnpj}</p></div>
                        <div class="text-right"><h2 class="font-bold text-[10px]">AVISO E RECIBO DE F√âRIAS</h2><p class="text-[9px] font-bold">IN√çCIO: ${h.dataInicio.split('-').reverse().join('/')}</p></div>
                    </div>
                    <div class="border border-black border-t-0 p-1 uppercase font-bold text-[9px] grid grid-cols-2">
                        <div class="border-r border-black p-1">COLABORADOR: ${h.nome}</div>
                        <div class="p-1">CARGO: ${h.cargo}</div>
                    </div>
                    <table class="w-full border-collapse mt-2">
                        <thead><tr class="bg-gray-100 font-bold uppercase text-[9px]"><th>DESCRI√á√ÉO</th><th>REF</th><th>VENCIMENTOS</th><th>DESCONTOS</th></tr></thead>
                        <tbody class="text-[9px]">
                            <tr><td>F√âRIAS (VALOR DO SAL√ÅRIO)</td><td class="text-center">${h.diasGozo}d</td><td class="text-right">${(h.salarioBase/30 * h.diasGozo).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td></td></tr>
                            ${h.valorMediaHE > 0 ? `
                                <tr><td>M√âDIA DE HORAS EXTRAS (PROPORCIONAL)</td><td class="text-center">${h.mediaMensalHoras.toFixed(2)}h/m</td><td class="text-right">${(h.valorMediaHE/30 * h.diasGozo).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td></td></tr>
                            ` : ''}
                            <tr><td>1/3 CONSTITUCIONAL S/ GOZO</td><td class="text-center">33.3%</td><td class="text-right">${h.umTercoGozo.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td></td></tr>
                            
                            ${h.extraAddManual > 0 ? `<tr><td>OUTROS ADICIONAIS</td><td>-</td><td class="text-right">${h.extraAddManual.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td></td></tr>` : ''}

                            ${h.diasVenda > 0 ? `
                                <tr><td>ABONO PECUNI√ÅRIO (VENDA)</td><td class="text-center">${h.diasVenda}d</td><td class="text-right">${h.valorVenda.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td></td></tr>
                                <tr><td>1/3 S/ ABONO PECUNI√ÅRIO</td><td class="text-center">33.3%</td><td class="text-right">${h.umTercoVenda.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td></td></tr>
                            ` : ''}
                            
                            <tr><td>INSS S/ F√âRIAS</td><td class="text-center">9%</td><td></td><td class="text-right">${h.inss.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td></tr>
                            ${h.extraDescManual > 0 ? `<tr><td>OUTROS DESCONTOS</td><td>-</td><td></td><td class="text-right">${h.extraDescManual.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td></tr>` : ''}
                        </tbody>
                        <tfoot class="font-bold text-[9px]">
                            <tr><td colspan="2" class="text-right">TOTAIS</td><td class="text-right">R$ ${(h.valorGozo + h.umTercoGozo + h.valorVenda + h.umTercoVenda + (h.extraAddManual || 0)).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td class="text-right">R$ ${(h.inss + (h.extraDescManual || 0)).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td></tr>
                        </tfoot>
                    </table>
                    <div class="mt-4 border border-black p-2 flex justify-between items-end">
                        <div><p class="text-[8px] font-bold uppercase">L√≠quido a Receber</p><p class="text-xl font-black">R$ ${h.liquido.toLocaleString('pt-BR',{minimumFractionDigits:2})}</p></div>
                        <div class="w-2/3 border-t border-black text-center text-[8px] pt-1">RECEBI O VALOR ACIMA EM ___/___/___ - ASSINATURA</div>
                    </div>
                </div>
            `;
        }

        // --- M√âTODOS DE APOIO ---
        function abrirModalFunc() { document.getElementById('form-cad-func').reset(); document.getElementById('func-id').value = ""; document.getElementById('modal-func').style.display = 'flex'; }
        function fecharModalFunc() { document.getElementById('modal-func').style.display = 'none'; }
        function logout() { sessionStorage.clear(); window.location.reload(); }

        document.getElementById('form-cad-func').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('func-id').value || Date.now().toString();
            const novo = {
                id,
                nome: document.getElementById('func-nome').value.toUpperCase(),
                cargo: document.getElementById('func-cargo').value.toUpperCase(),
                regime: document.getElementById('func-regime').value,
                salario: parseFloat(document.getElementById('func-salario').value),
                admissao: document.getElementById('func-admissao').value
            };
            db.funcionarios = db.funcionarios.filter(x => x.id !== id);
            db.funcionarios.push(novo);
            salvarDB();
            fecharModalFunc();
            init();
        };

        function renderTabelaFolha() {
            const list = document.getElementById('tabela-lancamento');
            list.innerHTML = db.funcionarios.map(f => `
                <tr class="hover:bg-slate-800/30">
                    <td class="p-4"><div class="font-bold text-white uppercase text-[10px]">${f.nome}</div></td>
                    <td class="p-4"><input type="time" id="hex-${f.id}" class="bg-slate-800 border border-slate-700 rounded p-1 text-white w-16 text-[10px]"></td>
                    <td class="p-4"><input type="time" id="hfa-${f.id}" class="bg-slate-800 border border-slate-700 rounded p-1 text-white w-16 text-[10px]"></td>
                    <td class="p-4"><input type="number" id="add-val-${f.id}" class="bg-slate-900 border border-slate-700 rounded p-1 text-[10px] text-blue-400 w-16"></td>
                    <td class="p-4"><input type="number" id="ext-val-${f.id}" class="bg-slate-900 border border-slate-700 rounded p-1 text-[10px] text-red-400 w-16"></td>
                    <td class="p-4 text-center"><button onclick="processar('${f.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-[9px] font-black uppercase">Gravar</button></td>
                </tr>
            `).join('');
        }

        function processar(fId) {
            const f = db.funcionarios.find(x => x.id === fId);
            const mes = document.getElementById('folha-mes').value;
            const tipo = document.getElementById('folha-tipo').value;
            const hex = document.getElementById(`hex-${fId}`).value || "00:00";
            const [hE, mE] = hex.split(':').map(Number);
            const totalHex = hE + (mE/60);
            const addVal = parseFloat(document.getElementById(`add-val-${fId}`).value) || 0;
            const extVal = parseFloat(document.getElementById(`ext-val-${fId}`).value) || 0;
            let salBase = f.salario > 500 ? f.salario : f.salario * 220;
            const vHE = totalHex * (salBase/220) * 1.5;
            const inss = (salBase + vHE + addVal) * 0.09;
            const reg = {
                id: `${f.id}-${mes}-${tipo}`, funcId: f.id, nome: f.nome, cargo: f.cargo, mes, tipo, regime: f.regime,
                vHE, totalHex, inss, extraAdd: { nome: "ADICIONAL", valor: addVal },
                extraDesc: { nome: "DESCONTO", valor: extVal }, salarioBase: salBase,
                liquido: (salBase + vHE + addVal) - (inss + extVal)
            };
            db.historico = db.historico.filter(h => h.id !== reg.id);
            db.historico.push(reg);
            salvarDB();
            renderHistorico();
            alert("Sucesso!");
        }

        function renderHistorico() {
            const list = document.getElementById('lista-historico');
            const filtroMes = document.getElementById('filtro-hist-mes').value;
            const filtrados = db.historico.filter(h => h.mes === filtroMes);
            if(filtrados.length === 0) { list.innerHTML = `<div class='text-center p-4 card-dark rounded-xl text-slate-500'>Vazio</div>`; return; }
            list.innerHTML = filtrados.map(h => `
                <div class="card-dark p-3 rounded-xl flex justify-between items-center text-[10px]">
                    <div><span class="font-bold text-white">${h.nome}</span><br><span class="text-slate-500">${h.tipo}</span></div>
                    <div class="flex items-center gap-2"><b>R$ ${h.liquido.toFixed(2)}</b><button onclick="visualizarHolerite('${h.id}')">üìÑ</button></div>
                </div>
            `).join('');
        }

        function gerarTemplateHolerite(h) {
            return `
                <div class="holerite-page">
                    <div class="border border-black p-2 flex justify-between items-center mb-1">
                        <div><h1 class="font-bold text-sm uppercase">${db.empresa.nome}</h1><p class="text-[9px]">CNPJ: ${db.empresa.cnpj}</p></div>
                        <div class="text-right font-bold text-[10px]">RECIBO DE PAGAMENTO<br>${h.mes}</div>
                    </div>
                    <div class="border border-black p-2 font-bold text-[9px]">${h.nome} - ${h.cargo}</div>
                    <table class="w-full border-collapse">
                        <tr class="bg-gray-100 font-bold uppercase text-[9px]"><th>DESCRI√á√ÉO</th><th>REF</th><th>PROVENTOS</th><th>DESCONTOS</th></tr>
                        <tr class="text-[9px]"><td>SAL√ÅRIO BASE</td><td class="text-center">30D</td><td class="text-right">${h.salarioBase.toFixed(2)}</td><td></td></tr>
                        ${h.vHE > 0 ? `<tr class="text-[9px]"><td>HORA EXTRA 50%</td><td class="text-center">${h.totalHex.toFixed(2)}h</td><td class="text-right">${h.vHE.toFixed(2)}</td><td></td></tr>` : ''}
                        <tr class="text-[9px]"><td>INSS</td><td class="text-center">9%</td><td></td><td class="text-right">${h.inss.toFixed(2)}</td></tr>
                    </table>
                    <div class="flex justify-between items-center mt-2 border border-black p-2 font-black">
                        <span>L√çQUIDO</span><span>R$ ${h.liquido.toFixed(2)}</span>
                    </div>
                </div>
            `;
        }

        function visualizarHolerite(id) {
            const h = db.historico.find(x => x.id === id);
            document.getElementById('print-area').innerHTML = h.tipo === "RECIBO DE F√âRIAS" ? gerarTemplateF√©rias(h) : gerarTemplateHolerite(h);
            document.getElementById('holerite-preview-container').style.display = 'block';
        }

        function salvarDB() {
            localStorage.setItem('dva_emp', JSON.stringify(db.empresa));
            localStorage.setItem('dva_func', JSON.stringify(db.funcionarios));
            localStorage.setItem('dva_hist', JSON.stringify(db.historico));
            localStorage.setItem('dva_ferias', JSON.stringify(db.ferias_gozadas));
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        document.getElementById('form-login').onsubmit = (e) => {
            e.preventDefault(); sessionStorage.setItem('dva_auth', 'true');
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden'); init();
        };

        function closeHolerite() { document.getElementById('holerite-preview-container').style.display = 'none'; }
        window.onload = () => { if(sessionStorage.getItem('dva_auth') === 'true') { document.getElementById('auth-container').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden'); init(); } };
    </script>
</body>
</html>
