<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metalurgica Pro - ERP RH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media print {
            body { background: white; p: 0; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .holerite-container { border: 1px solid #000; margin-bottom: 20px; page-break-inside: avoid; }
        }
        .font-mono-hr { font-family: 'Roboto Mono', monospace; }
    </style>
</head>
<body class="p-2 md:p-4">

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 no-print">
        <!-- Header -->
        <div class="bg-blue-900 p-6 text-white flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 p-2 rounded-lg italic font-black text-xl italic tracking-tighter">M-PRO</div>
                <div>
                    <h1 class="text-xl font-bold uppercase tracking-tight" id="headerNomeEmpresa">Minha Empresa</h1>
                    <p class="text-[10px] text-blue-300 font-bold uppercase tracking-widest">Sistema de Folha e Quinzena v4.0</p>
                </div>
            </div>
            <div class="text-right">
                <button onclick="openTab('config')" class="text-xs bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full font-bold transition">⚙ CONFIG. EMPRESA</button>
            </div>
        </div>

        <!-- Menu -->
        <div class="flex border-b bg-slate-50 overflow-x-auto">
            <button onclick="openTab('func')" class="tab-btn px-6 py-4 text-xs font-black border-b-2 border-transparent hover:text-blue-700 uppercase" id="btn-func">Funcionários</button>
            <button onclick="openTab('folha')" class="tab-btn px-6 py-4 text-xs font-black border-b-2 border-transparent hover:text-blue-700 uppercase" id="btn-folha">Lançar Folha</button>
            <button onclick="openTab('historico')" class="tab-btn px-6 py-4 text-xs font-black border-b-2 border-transparent hover:text-blue-700 uppercase" id="btn-historico">Holerites / Histórico</button>
            <button onclick="openTab('rescisao')" class="tab-btn px-6 py-4 text-xs font-black border-b-2 border-transparent hover:text-blue-700 uppercase" id="btn-rescisao">Rescisão</button>
        </div>

        <!-- Aba: CONFIG EMPRESA -->
        <div id="config" class="tab-content p-8">
            <h2 class="text-lg font-black mb-6 uppercase italic text-slate-800">Dados da Empresa (Cabeçalho do Holerite)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50 p-6 rounded-2xl border">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Razão Social</label>
                    <input type="text" id="emp_nome" class="w-full p-3 border rounded-xl outline-none font-bold uppercase">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">CNPJ</label>
                    <input type="text" id="emp_cnpj" placeholder="00.000.000/0001-00" class="w-full p-3 border rounded-xl outline-none font-bold">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Endereço Completo</label>
                    <input type="text" id="emp_end" class="w-full p-3 border rounded-xl outline-none uppercase font-medium">
                </div>
                <button onclick="salvarEmpresa()" class="bg-blue-700 text-white px-8 py-3 rounded-xl font-black hover:bg-blue-800 transition">SALVAR CONFIGURAÇÕES</button>
            </div>
        </div>

        <!-- Aba: FUNCIONÁRIOS -->
        <div id="func" class="tab-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-black uppercase text-slate-800">Cadastro de Colaboradores</h2>
                <button onclick="toggleFormFunc()" class="bg-slate-900 text-white px-6 py-2 rounded-full text-[10px] font-bold">+ NOVO CADASTRO</button>
            </div>
            
            <div id="formFunc" class="hidden mb-8 bg-slate-50 p-6 rounded-2xl border-2 border-dashed border-slate-200">
                <input type="hidden" id="edit_id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Nome</label>
                        <input type="text" id="f_nome" class="w-full p-2 border rounded-lg uppercase font-bold outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Cargo</label>
                        <input type="text" id="f_cargo" class="w-full p-2 border rounded-lg uppercase outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Salário Base (R$)</label>
                        <input type="number" step="0.01" id="f_salario" class="w-full p-2 border rounded-lg font-bold text-blue-700">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Data Admissão</label>
                        <input type="date" id="f_adm" class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="flex items-center gap-2 bg-white p-2 rounded border">
                        <input type="checkbox" id="f_insal" class="w-4 h-4">
                        <label class="text-[10px] font-bold uppercase">Insalubridade</label>
                    </div>
                    <div class="md:col-span-3 flex gap-2 pt-4">
                        <button onclick="salvarFunc()" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold">GRAVAR FUNCIONÁRIO</button>
                        <button onclick="toggleFormFunc()" class="bg-slate-200 px-6 py-3 rounded-xl font-bold">FECHAR</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="cardsFunc"></div>
        </div>

        <!-- Aba: LANÇAR FOLHA -->
        <div id="folha" class="tab-content p-6">
            <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h2 class="text-lg font-black uppercase text-slate-800">Lançamento por Período</h2>
                    <p class="text-xs text-slate-500 font-bold uppercase">Selecione se é Adiantamento (Quinzena) ou Folha Mensal</p>
                </div>
                <div class="flex gap-3">
                    <select id="tipoLancamento" class="p-3 border rounded-xl font-bold text-xs bg-white outline-none">
                        <option value="mensal">FOLHA MENSAL (SALÁRIO + EXTRAS)</option>
                        <option value="quinzena">ADIANTAMENTO (QUINZENA - 40%)</option>
                    </select>
                    <input type="month" id="mesRef" class="p-3 border rounded-xl font-bold outline-none text-blue-700">
                </div>
            </div>

            <div class="overflow-x-auto border rounded-2xl">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-900 text-white text-[10px] uppercase">
                        <tr>
                            <th class="p-4">Colaborador</th>
                            <th class="p-4">H. Extras / Faltas</th>
                            <th class="p-4">Descontos (Empréstimo/Outros)</th>
                            <th class="p-4 text-center">Processar</th>
                        </tr>
                    </thead>
                    <tbody id="listaLancar"></tbody>
                </table>
            </div>
        </div>

        <!-- Aba: HISTÓRICO / HOLERITES -->
        <div id="historico" class="tab-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-black uppercase">Holerites Emitidos</h2>
                <div class="flex gap-2">
                   <select id="filtroHist" onchange="renderHistorico()" class="p-2 border rounded-xl text-xs font-bold"></select>
                </div>
            </div>
            <div id="gridHist" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Aba: RESCISÃO (Simplificada conforme fluxos anteriores) -->
        <div id="rescisao" class="tab-content p-6">
            <div class="bg-slate-50 p-10 rounded-3xl text-center border-4 border-dashed">
                <p class="text-slate-400 font-bold uppercase">Utilize o seletor na aba Histórico para visualizar médias e gerar rescisões completas baseadas nos dados acima.</p>
            </div>
        </div>
    </div>

    <!-- ÁREA DE IMPRESSÃO (Oculta na tela) -->
    <div id="printArea" class="hidden print-only"></div>

    <script>
        // Banco de Dados Local
        let empresa = JSON.parse(localStorage.getItem('mpro_emp')) || { nome: 'MINHA METALURGICA', cnpj: '', end: '' };
        let funcionarios = JSON.parse(localStorage.getItem('mpro_func')) || [];
        let historico = JSON.parse(localStorage.getItem('mpro_hist')) || [];
        const SALARIO_MINIMO = 1518.00;

        function salvarEmpresa() {
            empresa.nome = document.getElementById('emp_nome').value;
            empresa.cnpj = document.getElementById('emp_cnpj').value;
            empresa.end = document.getElementById('emp_end').value;
            localStorage.setItem('mpro_emp', JSON.stringify(empresa));
            alert("Dados da Empresa salvos!");
            init();
        }

        function init() {
            document.getElementById('headerNomeEmpresa').innerText = empresa.nome || "METALURGICA PRO";
            document.getElementById('emp_nome').value = empresa.nome;
            document.getElementById('emp_cnpj').value = empresa.cnpj;
            document.getElementById('emp_end').value = empresa.end;
            renderAll();
        }

        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('border-blue-700', 'text-blue-700'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id)?.classList.add('border-blue-700', 'text-blue-700');
            renderAll();
        }

        function toggleFormFunc() {
            document.getElementById('formFunc').classList.toggle('hidden');
        }

        function salvarFunc() {
            const id = document.getElementById('edit_id').value;
            const f = {
                id: id ? parseInt(id) : Date.now(),
                nome: document.getElementById('f_nome').value.toUpperCase(),
                cargo: document.getElementById('f_cargo').value.toUpperCase(),
                salario: parseFloat(document.getElementById('f_salario').value),
                adm: document.getElementById('f_adm').value,
                insal: document.getElementById('f_insal').checked
            };
            if(!f.nome || isNaN(f.salario)) return alert("Preencha Nome e Salário!");
            
            if(id) {
                const idx = funcionarios.findIndex(x => x.id == id);
                funcionarios[idx] = f;
            } else {
                funcionarios.push(f);
            }
            localStorage.setItem('mpro_func', JSON.stringify(funcionarios));
            document.getElementById('edit_id').value = '';
            toggleFormFunc();
            renderAll();
        }

        function calcularINSS(base) {
            if (base <= 1621) return base * 0.075;
            if (base <= 2902) return (base * 0.09) - 24.31;
            if (base <= 4354) return (base * 0.12) - 111.40;
            if (base <= 8475) return (base * 0.14) - 198.48;
            return 988.09;
        }

        function processarFolha(fId) {
            const mes = document.getElementById('mesRef').value;
            const tipo = document.getElementById('tipoLancamento').value;
            if(!mes) return alert("Selecione o Mês!");

            const f = funcionarios.find(x => x.id == fId);
            const hExStr = document.getElementById(`hex-${fId}`).value || "00:00";
            const hFaStr = document.getElementById(`hfa-${fId}`).value || "00:00";
            const descEmp = parseFloat(document.getElementById(`emp-${fId}`).value) || 0;

            const valHora = f.salario / 220;
            const [hE, mE] = hExStr.split(':').map(Number);
            const decExtra = hE + (mE/60);
            const [hF, mF] = hFaStr.split(':').map(Number);
            const decFalta = hF + (mF/60);

            const vExtra = decExtra * valHora * 1.5;
            const vDsr = (vExtra / 25) * 5; // Estimado
            const vInsal = f.insal ? (SALARIO_MINIMO * 0.20) : 0;
            const vFalta = decFalta * valHora;

            // Busca adiantamento se for folha mensal
            let vAdiantamento = 0;
            if(tipo === 'mensal') {
                const histAdiant = historico.find(h => h.fId == fId && h.mes == mes && h.tipo == 'quinzena');
                if(histAdiant) vAdiantamento = histAdiant.proventos;
            }

            const proventos = tipo === 'quinzena' ? (f.salario * 0.40) : (f.salario + vExtra + vDsr + vInsal);
            
            let descontos = 0;
            let inss = 0;
            if(tipo === 'mensal') {
                inss = calcularINSS(proventos - vFalta);
                descontos = vFalta + inss + vAdiantamento + descEmp;
            } else {
                descontos = descEmp; // No adiantamento geralmente só desconta empréstimo se houver acordo
            }

            const novoHist = {
                id: Date.now(),
                fId: fId,
                nome: f.nome,
                cargo: f.cargo,
                salarioBase: f.salario,
                mes: mes,
                tipo: tipo,
                proventos: proventos,
                descontos: descontos,
                liquido: proventos - descontos,
                detalhes: {
                    vExtra, vDsr, vInsal, vFalta, inss, vAdiantamento, descEmp, hExStr, hFaStr
                }
            };

            historico = historico.filter(h => !(h.fId == fId && h.mes == mes && h.tipo == tipo));
            historico.push(novoHist);
            localStorage.setItem('mpro_hist', JSON.stringify(historico));
            alert(`Lançamento de ${tipo.toUpperCase()} realizado com sucesso!`);
            renderAll();
        }

        function imprimirHolerite(id) {
            const h = historico.find(x => x.id == id);
            const f = funcionarios.find(x => x.id == h.fId);
            const pArea = document.getElementById('printArea');

            const linhas = [];
            if(h.tipo === 'quinzena') {
                linhas.push({ cod: '001', desc: 'ADIANTAMENTO QUINZENAL (40%)', ref: '40%', prov: h.proventos, desc: 0 });
            } else {
                linhas.push({ cod: '001', desc: 'SALÁRIO BASE', ref: '30D', prov: h.salarioBase, desc: 0 });
                if(h.detalhes.vInsal > 0) linhas.push({ cod: '062', desc: 'INSALUBRIDADE', ref: '20%', prov: h.detalhes.vInsal, desc: 0 });
                if(h.detalhes.vExtra > 0) linhas.push({ cod: '050', desc: 'HORAS EXTRAS 50%', ref: h.detalhes.hExStr, prov: h.detalhes.vExtra, desc: 0 });
                if(h.detalhes.vDsr > 0)   linhas.push({ cod: '051', desc: 'DSR S/ EXTRAS', ref: '', prov: h.detalhes.vDsr, desc: 0 });
                
                if(h.detalhes.vFalta > 0) linhas.push({ cod: '901', desc: 'FALTAS/ATRASOS', ref: h.detalhes.hFaStr, prov: 0, desc: h.detalhes.vFalta });
                if(h.detalhes.inss > 0)   linhas.push({ cod: '905', desc: 'INSS FOLHA', ref: '', prov: 0, desc: h.detalhes.inss });
                if(h.detalhes.vAdiantamento > 0) linhas.push({ cod: '910', desc: 'DESC. ADIANTAMENTO (QUINZENA)', ref: '', prov: 0, desc: h.detalhes.vAdiantamento });
                if(h.detalhes.descEmp > 0) linhas.push({ cod: '920', desc: 'DESC. EMPRÉSTIMO CLT', ref: '', prov: 0, desc: h.detalhes.descEmp });
            }

            let htmlLinhas = '';
            linhas.forEach(l => {
                htmlLinhas += `
                    <tr class="text-[11px] font-mono-hr">
                        <td class="border-x px-2 py-1">${l.cod}</td>
                        <td class="border-x px-2 py-1">${l.desc}</td>
                        <td class="border-x px-2 py-1 text-center">${l.ref}</td>
                        <td class="border-x px-2 py-1 text-right">${l.prov > 0 ? l.prov.toLocaleString('pt-BR',{minimumFractionDigits:2}) : ''}</td>
                        <td class="border-x px-2 py-1 text-right">${l.desc > 0 ? l.desc.toLocaleString('pt-BR',{minimumFractionDigits:2}) : ''}</td>
                    </tr>
                `;
            });

            pArea.innerHTML = `
                <div class="holerite-container p-6 w-[210mm] mx-auto bg-white border border-black mb-10">
                    <div class="flex justify-between border-b border-black pb-2 mb-2">
                        <div class="text-[12px] font-bold">
                            ${empresa.nome}<br>
                            CNPJ: ${empresa.cnpj}<br>
                            ${empresa.end}
                        </div>
                        <div class="text-right text-[14px] font-black uppercase">
                            Recibo de Pagamento de Salário<br>
                            <span class="text-[10px]">${h.tipo === 'quinzena' ? 'ADIANTAMENTO' : 'MENSAL'} - ${h.mes}</span>
                        </div>
                    </div>
                    <table class="w-full border border-black mb-2 text-[10px]">
                        <tr class="bg-slate-100">
                            <th class="border border-black p-1 text-left">NOME DO FUNCIONÁRIO</th>
                            <th class="border border-black p-1 text-left">CARGO</th>
                            <th class="border border-black p-1 text-left">ADMISSÃO</th>
                        </tr>
                        <tr>
                            <td class="border border-black p-1 font-bold">${h.nome}</td>
                            <td class="border border-black p-1">${h.cargo}</td>
                            <td class="border border-black p-1">${f.adm.split('-').reverse().join('/')}</td>
                        </tr>
                    </table>
                    <table class="w-full border border-black text-sm mb-4">
                        <thead class="bg-slate-50 text-[10px]">
                            <tr>
                                <th class="border border-black p-1 w-12">CÓD.</th>
                                <th class="border border-black p-1 text-left">DESCRIÇÃO</th>
                                <th class="border border-black p-1 w-20 text-center">REF.</th>
                                <th class="border border-black p-1 w-24 text-right">PROVENTOS</th>
                                <th class="border border-black p-1 w-24 text-right">DESCONTOS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${htmlLinhas}
                            ${Array(10 - linhas.length).fill('<tr class="h-5"><td class="border-x"></td><td class="border-x"></td><td class="border-x"></td><td class="border-x"></td><td class="border-x"></td></tr>').join('')}
                        </tbody>
                        <tfoot class="font-bold bg-slate-100">
                            <tr>
                                <td colspan="3" class="border border-black p-1 text-right">TOTAIS:</td>
                                <td class="border border-black p-1 text-right">R$ ${h.proventos.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
                                <td class="border border-black p-1 text-right">R$ ${h.descontos.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="flex justify-between items-center mt-6">
                        <div class="bg-slate-900 text-white p-4 rounded text-center min-w-[200px]">
                            <span class="text-[10px] block opacity-50 font-bold uppercase">Valor Líquido</span>
                            <span class="text-xl font-black">R$ ${h.liquido.toLocaleString('pt-BR',{minimumFractionDigits:2})}</span>
                        </div>
                        <div class="text-right border-t border-black w-1/2 pt-2 text-[10px]">
                            DATA: ____/____/_______ &nbsp;&nbsp;&nbsp; ASSINATURA: _________________________________________
                        </div>
                    </div>
                </div>
                <div class="text-center text-[10px] mb-4 opacity-50 no-print">--- Via do Empregador acima / Via do Empregado abaixo ---</div>
            `;
            
            window.print();
        }

        function renderAll() {
            // Funcionários
            const cFunc = document.getElementById('cardsFunc');
            cFunc.innerHTML = '';
            funcionarios.forEach(f => {
                cFunc.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl border shadow-sm">
                        <h3 class="font-black text-slate-800">${f.nome}</h3>
                        <p class="text-[10px] text-blue-600 font-bold uppercase">${f.cargo}</p>
                        <div class="mt-3 flex justify-between items-end border-t pt-3">
                            <span class="text-xs font-bold text-slate-400 uppercase">Salário: R$ ${f.salario.toLocaleString('pt-BR')}</span>
                            <button onclick="editarFunc(${f.id})" class="text-blue-600 font-black text-[10px] uppercase">Editar</button>
                        </div>
                    </div>
                `;
            });

            // Lançar Folha
            const tLancar = document.getElementById('listaLancar');
            tLancar.innerHTML = '';
            funcionarios.forEach(f => {
                tLancar.innerHTML += `
                    <tr class="border-b">
                        <td class="p-4"><div class="font-bold text-xs uppercase">${f.nome}</div><div class="text-[8px] text-slate-400">BASE R$ ${f.salario}</div></td>
                        <td class="p-4 flex gap-2">
                            <input type="time" id="hex-${f.id}" title="Extras" class="border p-1 text-xs rounded w-20">
                            <input type="time" id="hfa-${f.id}" title="Faltas" class="border p-1 text-xs rounded w-20">
                        </td>
                        <td class="p-4"><input type="number" id="emp-${f.id}" placeholder="R$ Desconto" class="border p-1 text-xs rounded w-32"></td>
                        <td class="p-4 text-center"><button onclick="processarFolha(${f.id})" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-[10px] font-black">GRAVAR</button></td>
                    </tr>
                `;
            });

            // Histórico
            renderHistorico();
        }

        function renderHistorico() {
            const grid = document.getElementById('gridHist');
            grid.innerHTML = '';
            historico.sort((a,b) => b.id - a.id).forEach(h => {
                grid.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <span class="bg-slate-900 text-white text-[8px] font-black px-2 py-1 rounded uppercase">${h.tipo} - ${h.mes}</span>
                            <button onclick="imprimirHolerite(${h.id})" class="text-blue-600 hover:text-blue-800 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                            </button>
                        </div>
                        <h4 class="font-bold text-slate-800 text-sm">${h.nome}</h4>
                        <div class="mt-3 flex justify-between font-black text-slate-900 border-t pt-2">
                            <span class="text-[9px] uppercase opacity-40">Líquido:</span>
                            <span>R$ ${h.liquido.toLocaleString('pt-BR',{minimumFractionDigits:2})}</span>
                        </div>
                        <button onclick="deletarHist(${h.id})" class="text-[8px] text-red-300 font-bold mt-2 uppercase">Excluir Registro</button>
                    </div>
                `;
            });
        }

        function deletarHist(id) {
            if(confirm("Deseja apagar este registro?")) {
                historico = historico.filter(x => x.id !== id);
                localStorage.setItem('mpro_hist', JSON.stringify(historico));
                renderAll();
            }
        }

        window.onload = init;
    </script>
</body>
</html>